# Repo: FirelyTeam/Vonk.IdentityServer.Test
# File: build/azure-pipelines.yml
name: $(SourceBranchName)-$(Date:yyyyMMdd)$(Rev:-r)

resources:
  repositories:
    - repository: templates
      type: github
      name: FirelyTeam/azure-pipeline-templates
      endpoint: FirelyTeam 

variables:
  buildConfiguration: 'Release'
  azureSubscription: vonk-identityserver

stages:
- stage: build
  jobs:
  - template: build.yml@templates  # Template reference
    parameters:
      dotNetCoreVersion: '3.x'
      pool:
        name: 'Private pool'
  - job: publish
    steps:
    - task: DotNetCoreCLI@2
      displayName: 'dotnet publish'
      inputs:
        command: publish
        publishWebProjects: true
        zipAfterPublish: true
        projects: |
         **\*.csproj
         !**\*Tests.csproj
        arguments: '-o $(Build.ArtifactStagingDirectory)/published -c $(buildConfiguration)'
    - task: PublishBuildArtifacts@1
      name: PublishedWebSite
      displayName: 'Publish Artifact: PublishedWebSite'
      inputs:
        PathtoPublish: '$(Build.StagingDirectory)/published'      
    
- stage: deploy
  dependsOn: build
  jobs: 
  - job: deploy
    steps:
    - task: AzureWebApp@1
      displayName: Azure Web App Deploy
      inputs:
        appType: webApp
        azureSubscription: $(azureSubscription)
        appName: vonk-identityserver
        package: $(Build.StagingDirectory)/drop/**/*.zip
